<!-- Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ===== קריאת JSON בצורה ידידותית ל-GitHub Pages =====
  // שים לב: אין סלאש מוביל. הנתיב יחסי למסמך הנוכחי, ולכן יעבוד גם תחת /<repo>/.
  const JSON_FILE = 'data/ibkr_data.json';

  // החזקת הדאטה לאחר טעינה
  let data = null;

  // אלמנטים מה־DOM
  const categorySelect = document.getElementById('category-select');
  const subcategoriesContainer = document.getElementById('subcategories-container');
  const chartTypeSelect = document.getElementById('chart-type-select');
  const plotButton = document.getElementById('plot-btn');
  let chart = null;

  // טעינת JSON (עם ביטול קאש בזמן פיתוח)
  async function loadData() {
    // בזמן פיתוח אפשר להוסיף ?v=Date.now() כדי לעקוף קאש. בפרודק्शन אפשר להסיר.
    const url = `${JSON_FILE}?v=${Date.now()}`;
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) {
      throw new Error(`Failed to load ${JSON_FILE}: HTTP ${res.status}`);
    }
    return await res.json();
  }

  // אתחול קטגוריות לאחר טעינה
  function initCategories() {
    categorySelect.innerHTML = '';
    Object.keys(data).forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      categorySelect.appendChild(option);
    });
    updateSubcategories();
  }

  // עדכון תת-קטגוריות
  function updateSubcategories() {
    subcategoriesContainer.innerHTML = '';
    const selectedCat = categorySelect.value;
    if (!selectedCat) return;
    const subcats = Object.keys(data[selectedCat]);
    subcats.forEach(sub => {
      const label = document.createElement('label');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = sub;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(sub));
      subcategoriesContainer.appendChild(label);
    });
  }
  categorySelect.addEventListener('change', updateSubcategories);

  // המרת ערכים ממחרוזת למספר
  function parseValue(val) {
    if (val === null || val === undefined || val === '') return null;
    const s = String(val).trim();
    if (s === '-' || s === '—') return null;
    let multiplier = 1;
    let numStr = s;
    if (s.endsWith('B')) { multiplier = 1e9;  numStr = s.slice(0, -1); }
    else if (s.endsWith('M')) { multiplier = 1e6; numStr = s.slice(0, -1); }
    else if (s.endsWith('K') || s.endsWith('k')) { multiplier = 1e3; numStr = s.slice(0, -1); }
    const num = parseFloat(numStr.replace(/,/g, ''));
    if (isNaN(num)) return null;
    return num * multiplier;
  }

  // ציור הגרף
  function drawChart() {
    const selectedCat = categorySelect.value;
    const checkboxes = subcategoriesContainer.querySelectorAll('input[type="checkbox"]:checked');
    const chartType = chartTypeSelect.value;
    if (!selectedCat || checkboxes.length === 0) {
      alert('נא לבחור קטגוריה ותת-קטגוריות להצגה.');
      return;
    }

    const labels = Object.keys(data[selectedCat][checkboxes[0].value]);
    const datasets = [];
    checkboxes.forEach((box, idx) => {
      const subcat = box.value;
      const values = data[selectedCat][subcat];
      const dataPoints = labels.map(year => parseValue(values[year]));
      datasets.push({
        label: subcat,
        data: dataPoints,
        fill: false,
        borderColor: `hsl(${(idx * 60) % 360}, 70%, 50%)`,
        backgroundColor: `hsl(${(idx * 60) % 360}, 70%, 50%)`,
        pointRadius: 3
      });
    });

    const ctx = document.getElementById('dataChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: chartType,
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: true, text: 'IBKR – הצגת נתונים דינמית' },
          legend: { display: true, position: 'top' }
        },
        scales: {
          x: { title: { display: true, text: 'שנה' } },
          y: {
            title: { display: true, text: 'ערך מספרי' },
            ticks: { callback: value => value.toLocaleString() }
          }
        }
      }
    });
  }

  plotButton.addEventListener('click', drawChart);

  // הפעלה ראשונית
  (async () => {
    try {
      data = await loadData();     // ← כאן נטענים הנתונים מה-JSON היחסי
      initCategories();
    } catch (e) {
      console.error(e);
      alert('שגיאה בטעינת הנתונים. ודא שקובץ data/ibkr_data.json קיים ושהנתיב יחסי (ללא סלאש מוביל).');
    }
  })();
</script>
